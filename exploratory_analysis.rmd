---
output:
  html_document: default
  pdf_document: default
---
# AirBnb

Load required packages.

```{r load packages, warning=FALSE, message=FALSE}

library( tidyverse )
library( dplyr )
library( gridExtra )
library( ggridges )
library( mapview )
library( leaflet )
library( leaflet.extras )
library( scales )
library( stargazer )
library( GGally )
library( corrplot )
library( tm )
library( wordcloud )
library( broom )
library( Hmisc )
library( geosphere )

```

Set up workspace, i.e., remove all existing data from working memory and load data from CSV file.

```{r setup}

rm( list=ls() )
df <- read.csv("./data/airbnb_clean.csv")

```

# General analysis

## Correlation matrix

To get an overview of the data, explore correlations between variables.

```{r}
# Correlation table with p-values
correlation_data <- df[, c("price", "minimum_nights", "number_of_reviews", 
                           "reviews_per_month", "name_length",
                           "calculated_host_listings_count", "availability_365")]

result <- rcorr(as.matrix(correlation_data))
result$r  # correlation matrix
result$P  # p-values

# Calculate the correlation matrix
cor_matrix <- cor(correlation_data, use = "complete.obs")

# Visualize the correlation matrix using corrplot
corrplot(cor_matrix, method = "color", type = "upper", 
         title = "Correlation Matrix", mar = c(0,0,1,0))

```
All correlations are significant except name_length correlated with minimum_nights and number_of_reviews.

Price:
Exhibits only weak correlations. The slight negative association with number_of_reviews (-0.048) could signal that affordability may marginally boost popularity. Minimal positive correlations are seen with name_length (0.042) and calculated_host_listings_count (0.057), pointing toward  influences on pricing through strategic naming or a host's experience. There is also a small positive link with availability_365 (0.082).

Minimum Nights:
An inverse relationship is noted with number_of_reviews (-0.082) and reviews_per_month (-0.123). This could be due to these apartments having less turnover or being less popular to rent. Positive relationships with availability_365 (0.146) and calculated_host_listings_count (0.131).

Number of Reviews:
The positive correlation with availability_365 (0.172) implies that properties with higher availability tend to garner more reviews. A subtle positive relationship with name_length (0.087), indicating greater popularity of these apartments.

Name Length:
The positive correlation with calculated_host_listings_count (0.152) could indicate that more experienced hosts might employ more detailed names for their listings.

Host Listings Count:
The positive association with availability_365 (0.226) proposes that hosts with a higher listing count tend to offer listings with higher availability. They may be less likely to use their apartments privately, thereby being able to offer them for rent more frequently.


Examine correlations divided by neighborhood.

```{r}
unique_groups <- unique(df$neighbourhood_group)

for (group in unique_groups) {
  
  subset_df <- df[df$neighbourhood_group == group,]
  
  # Subset the data to include only relevant numeric variables
  correlation_data <- subset_df[, c("price", "minimum_nights", "number_of_reviews", 
                                    "reviews_per_month", "name_length",
                                    "calculated_host_listings_count", "availability_365")]

  # Calculate the correlation matrix for the subset
  cor_matrix <- cor(correlation_data, use = "complete.obs")
  
  # Visualize the correlation matrix using corrplot
  corrplot(cor_matrix, method = "color", type = "upper", 
           title = paste("Correlation Matrix for", group), mar = c(0,0,1,0))
}

```

Price:
Notably negative correlation with number_of_reviews especially in Manhattan and Staten Island; positive correlation with name_length only in Manhattan. A nuanced relationship with calculated_host_listings_count across neighborhoods; consistent slight positive with availability, strongest in Manhattan.
    
Minimum Nights:
Uniformly negative correlation with number_of_reviews and reviews_per_month; positive with availability across regions. Generally maintains a positive relationship with calculated_host_listings_count, barring Staten Island.

Number of Reviews:
A consistent positive correlation between number_of_reviews and availability is observed across all neighborhood groups, reaffirming that heightened availability may foster increased reviews. A mild negative correlation with calculated_host_listings_count persists generally, with Staten Island being an exception.

Name Length:
The positive correlation between name_length and calculated_host_listings_count is generally upheld, albeit with Brooklyn diverging from this trend, suggesting variations in naming strategies among hosts with multiple listings.

Calculated Host Listings Count:
A consistent positive relationship with availability across all neighborhoods indicates that hosts with multiple listings might offer increased availability across their properties.

Notably, Manhattan and Staten Island occasionally diverge from a general trend.


## Number of listings by area

```{r}

ggplot(df, aes(x=longitude, y=latitude)) + 
  geom_density_2d_filled(show.legend = TRUE, aes(fill = ..level..)) + 
  coord_cartesian(xlim = c(-74.08, -73.85), ylim = c(40.64, 40.86)) + 
  labs(title="Density Heatmap of Listings", x="Longitude", y="Latitude") + 
  theme_minimal()

# Bar plot to see which neighborhood groups have the most listings:

df %>% 
  filter(!is.na(neighbourhood_group)) %>% 
  ggplot(aes(x = neighbourhood_group)) + 
  geom_bar() + 
  labs(
    title = "Listings by Neighbourhood Group", 
    x = "Neighbourhood Group", 
    y = "Frequency"
  )

```

Most listings in the dataset are in Manhattan and Brooklyn.


## Room types

```{r}
# Distribution of Room Type
df %>% 
  filter(!is.na(neighbourhood_group)) %>% 
  ggplot(aes(x=room_type)) + 
  geom_bar() + 
  labs(title="Distribution of Room Types", x="Room Type", y="Frequency")

# Room Types by Location
df %>% 
  filter(!is.na(neighbourhood_group)) %>% 
  ggplot(aes(x=neighbourhood_group, fill=room_type)) + 
  geom_bar(position="dodge") +
  labs(title="Distribution of Room Types by Neighbourhood Group", 
       x="Neighborhood", y="Frequency")

# Geographic distribution of private room vs. apartment
df %>% 
  filter(room_type %in% c('Private room', 'Entire home/apt')) %>% 
  ggplot(aes(x = longitude, y = latitude, color = room_type)) + 
  geom_point() + 
  scale_color_manual(values = c("Private room" = "blue", "Entire home/apt" = "red")) +
  labs(title = "Geographic Distribution of 'Private Room' vs. 'Entire home/apt'",
       x = "Longitude", 
       y = "Latitude",
       color = "Room Type")

# Price by Room Type
df %>%
  filter(!is.na(log_price) & !is.na(room_type)) %>%
  ggplot(aes(x = room_type, y = log_price)) +
  geom_boxplot() +
  labs(title = "Boxplot of Price vs. Room Type",
       x = "Room Type",
       y = "Log Price")

#Price bins by Room Type
ggplot(df, aes(x=price_bin, fill=room_type)) +
  geom_bar(position="dodge") +   # Use "stack" for a stacked bar plot
  labs(title="Price Bins per Room Type", 
       x="Price Bins", 
       y="Count")

```
Only few listing are for a shared room.

In Manhattan, most listings are for an entire home/apartment, while in other neighborhoods, private rooms dominate. Brooklyn stands out as a balanced neighborhood with almost equal representation of both types.

Listings for an entire home/apt tend to be more expensive, followed by private and shared rooms.


## Price and Location

```{r}
df %>% 
  filter(!is.na(price_bin)) %>% 
  ggplot(aes(x=price_bin)) +
    geom_bar() +
    labs(title="Distribution of Price Bins", x="Price Bins", y="Frequency") +
    facet_wrap(~neighbourhood_group, scales = "free_y")

# Boxplot: Price vs. Neighbourhood Group
df %>%
  filter(!is.na(log_price) & !is.na(neighbourhood_group)) %>%
  ggplot(aes(x = neighbourhood_group, y = log_price)) +
  geom_boxplot() +
  labs(title = "Boxplot of Price vs. Neighbourhood Group",
       x = "Neighbourhood Group",
       y = "Log Price")

# Geographic distribution of price bins
df %>% 
  filter(!is.na(price_bin)) %>% 
  ggplot(aes(x=longitude, y=latitude, color=price_bin)) +
    geom_point(alpha=0.5) +
    scale_color_brewer(palette="Set2") +
    labs(title="Geographic Distribution of Price Bins",
         x="Longitude",
         y="Latitude")

# Geographic distribution of log_price
ggplot(df, aes(x=longitude, y=latitude)) + 
  geom_point(aes(color=log_price), alpha=0.5) +
  scale_color_viridis_c(option = "viridis") +
  labs(title="Heatmap of Prices", x="Longitude", y="Latitude")

```
In the Manhattan area, the majority of listings are priced between $101-200, followed by listings in the $201-500 range. Notably, there are very few listings in the $0-50 price range compared to the other neighborhood groups. Queens predominantly features listings in the $51-100 price range, complemented by a significant number of listings priced between $0-50. Brooklyn has both a lot of 101-200 and 51-100 listings. Note the different scales on the y axis.

Manhattan appears to have the highest median log price among the five neighbourhood groups. It also has the most variability in log prices. Manhattan and Brooklyn also have several outliers, indicating some extremely high-priced listings. Brooklyn and Queens seem to have roughly similar median log prices, though Brooklyn's is slightly higher. Bronx and Staten Island have the lowest median log prices.

Manhattan and Brooklyn seem to be slightly right-skewed, as the whisker on the upper side is longer than the one on the lower side. Bronx, Queens, and Staten Island are more symmetric, as their boxes and whiskers are relatively evenly spread around the median.

The area further to the southwest displays a higher concentration of listings in the $0-50 range. Listings with a price range of $501-1000 are sparsely distributed, with a majority found towards the south, east, and north regions.
    
In southern Manhattan, the predominant hue is green, indicating the steepest prices. Surrounding regions also reflect elevated pricing, demonstrating a gradient effect. As we traverse Brooklyn and Queens, the intensity of green diminishes but remains brighter proximate to Manhattan. Venturing further to the east, north, or south reveals a decline in the average price, signified by progressively more dark green/blue shades.

Since the variation between neighborhoods is high, analyses should be performed separately or they may be confounded by neighborhood_group.

### Distance from center

```{r}
cor_price_distance <- cor.test(df$log_price, df$distance_from_center, method = "pearson")
print(paste("Correlation between log price and distance from center: ", cor_price_distance$estimate))

# Scatter Plot: Price vs. Distance from Center
ggplot(df, aes(x = distance_from_center, y = log_price)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Scatter Plot of Price vs. Distance from Center",
       x = "Distance from Center",
       y = "Log Price")

```

The correlation coefficient of -0.4604 suggests a moderate negative relationship.


## Word Cloud

Which terms are used most often in descriptions?

```{r}
# Create a Corpus
text <- Corpus(VectorSource(df$name))

# Convert all characters to lowercase, remove punctuation and common English stopwords (e.g., "and", "the", "of")
text <- tm_map(text, content_transformer(tolower))
text <- tm_map(text, removePunctuation)
text <- tm_map(text, removeWords, stopwords("en"))

# Create a term-document matrix
# Rows represent terms (words) and columns represent individual entries from df$name. The values in the matrix indicate the frequency of a term in a given document.
tdm <- TermDocumentMatrix(text)

# Calculate word frequencies, sorted in decreasing order
m <- as.matrix(tdm)
word_freqs <- sort(rowSums(m), decreasing=TRUE) 

# Create a data frame with two columns: word (the terms or words) and freq (their respective frequencies)
dm <- data.frame(word = names(word_freqs), freq = word_freqs)

# Create a basic wordcloud
wordcloud(words=dm$word, freq=dm$freq, min.freq=1, max.words=150, random.order=FALSE)

```

Clean up workspace

```{r}

rm(m)
rm(dm)
rm(tdm)
rm(text)

```

# Earnings analysis

## Data Exploration

Examine summary statistics including range, and overview distribution of earnings

```{r}

summary(df$lowest_monthly_earnings)

max(df$lowest_monthly_earnings) - min(df$lowest_monthly_earnings)

df %>%
  ggplot(aes(lowest_monthly_earnings)) +
  geom_histogram() +
  scale_y_continuous()

```

As the distribution is extremely skewed to the right, we will conduct a log-transformation

```{r}

# log-transform earnings + filter out infinite values
df <- df %>%
  mutate(log_earnings = log(lowest_monthly_earnings)) %>%
  filter(is.finite(log_earnings), is.finite(log_price), is.finite(log_reviews_per_month))

# store summary statistics of earnings distribution
# upper whisker
IQR <- IQR(df$log_earnings)
calc_upper_whisker <- (quantile(df$log_earnings, probs = 0.75) + IQR*1.5)
select_upper_whisker <- df$log_earnings >= calc_upper_whisker
upper_whisker <- df$log_earnings[select_upper_whisker]
upper_whisker <- min(upper_whisker)

# lower whisker
calc_lower_whisker <- (quantile(df$log_earnings, probs = 0.25) - IQR*1.5)
select_lower_whisker <- df$log_earnings <= calc_lower_whisker
lower_whisker <- df$log_earnings[select_lower_whisker]
lower_whisker <- max(lower_whisker)

# upper and lower quartile and median
earnings_distribution <- c(
  min(df$log_earnings), 
  quantile(df$log_earnings, probs = c(0.25, 0.5, 0.75)),
  max(df$log_earnings)
)

#draw histogram
df %>%
  ggplot(aes(x = log_earnings)) +
  geom_histogram() +
  labs(title="Earnings Distribution") +
  xlab("Logged Earnings") +
  ylab("Frequency") 

# draw boxplot showing delogged values
df %>%
  ggplot(aes(y = log_earnings)) +
  geom_boxplot() +
  stat_boxplot(geom = "errorbar") +
  scale_y_continuous(breaks = c(earnings_distribution, lower_whisker, upper_whisker), 
                     labels = as.integer(exp((c(earnings_distribution, lower_whisker, upper_whisker))))) +
  scale_x_continuous(breaks = NULL, labels = NULL) +
  labs(
    y = "Lowerst Monthly Earnings (De-Logged)",
    title = "Earnings Distribution"
  )

# violin plot by neighbourhood groups
df %>%
  ggplot(aes(x = reorder(neighbourhood_group, +lowest_monthly_earnings), y = log_earnings)) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), trim = TRUE) +
  labs(
    title = "Earnings Distribution by Earnings",
    x = ""
  )


```

The lowest monthly earnings are approximately normally distributed.
50% of listings have earned up to 225 per month. 75% of listings have earned up to 612 per month.
There is much more variance in monthly earnings in the upper 25% of the distribution.
As seen in the original boxplot, some outliers have extremely high earnings.


```{r}
# create vector inidicating position in earnings distribution
q9 <- quantile(df$lowest_monthly_earnings, probs = 0.9)
quantile_indicator <- ifelse(df$lowest_monthly_earnings > q9, "upper 10%", "lower 90%")
df <- cbind(df, quantile_indicator)

# 

earningsplot_df <- df %>%
  group_by(quantile_indicator) %>%
  summarise(
    tot_earnings_mio = (sum(lowest_monthly_earnings)/1000000)
  )

earningsplot_df %>%
  ggplot(aes(quantile_indicator, tot_earnings_mio)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = sprintf("%.2f", earningsplot_df$tot_earnings_mio)), vjust = -0.5, size = 3) +
  scale_y_continuous(breaks = seq(0, max(earningsplot_df$tot_earnings_mio), by = 3)) +
  labs(
    title = "Total Earnings of upper 10% and lower 90% of Distribution",
    y = "Lowest Monthley Earnings in Mio",
    x = NULL
  )
ggsave("tot_earn_by_distribution.pdf")

```

The upper 10% of listings earn almost 150% of the lower 90%.

```{r}
# examine how much each neighbourhood group earns and the share of room types for each

earningsplot_hood_room <- df %>%
  group_by(neighbourhood_group, room_type) %>%
  summarise(
    tot_earnings_mio = (sum(lowest_monthly_earnings)/1000000),
  )

n_hood <- df %>%
  group_by(neighbourhood_group) %>%
  summarise(
    count = n())

earningsplot_hood_room %>%
  ggplot(aes(x = reorder(neighbourhood_group, +tot_earnings_mio), y = tot_earnings_mio, fill = room_type)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(breaks = seq(0, 20, by = 1)) +
  labs(
    title = "Total Earnings by Neighbourhood and Room Type",
    y = "Lowest Monthly Earnings in Mio",
    x = NULL,
    fill = "Room Type"
  )

```
Home-type listings in Manhattan generate the most earnings

```{r}

# Relationships between earnings and other variables

df %>%
  ggplot(aes(x = , y = log_earnings))
```


# Geographic analysis

## Distances

First we want to observe the correlation between price per night and the distance to the biggest airport jfk.
```{r}

plot(df$distance_to_jfk, df$price)

```
Since their are a few outliers in price, we can either use the variable log_price or use the 99pct quartil of the variable price. 
Furthermore there seem to be listings > 30km away from jfk. Those will be removed as well.
```{r}

price_pct99 <- quantile(df$price, probs = 0.99)

#create new dataframe where outliers are removed
df_2 <- df %>% filter(price < price_pct99) %>% filter(distance_to_jfk < 30)

```

```{r}

plot(df_2$distance_to_jfk, df_2$price)

```
Now we want to proceed with a linear regression.
```{r}
lin_model_jfk <- lm(price ~ distance_to_jfk, data = df_2)
summary(lin_model_jfk)

plot(df_2$distance_to_jfk, df_2$price, xlab = "Distance to JFK (in kilometers)", ylab = "Price per night (in $)", main = "Regression anaylsis (distance to JFK vs price per night)")
abline(lin_model_jfk, col = "red")
```
A significant correlation between distance to JFK and price per night (ppn) can be observed. The ppn increases around 7$ with every kilometer distance, c.p.. This result is intuitve since apartments around the airport i.e. airport hotels are always cheaper. Furthermore apartments nearer to the airport could be less expensive due to external factors like the noise of planes. 
In further discussions can be observed, if the outliers > 30km away from JFK could have a negative impact on the price, i.e. these apartments are to far away from center points of NY.

Now we conclued with the same anaylsis, but for all three airports.
```{r}
lin_model_airports <- lm(price ~ distance_to_jfk + distance_to_ewr + distance_to_lga, data = df_2)
summary(lin_model_airports)
```
Lets check for correlation between the price and the distance to NY sights.
```{r}
lin_model_sights <- lm(price ~ distance_to_esb + distance_to_sol + distance_to_cp, data = df_2)
summary(lin_model_sights)
```
The impact of sights is always significant. The estimate for esb is negative which is intuitve, because in the surounding area the rent is high, which leads to higher ppn in the listed airbnbs. Moving away from the center has therefore negative impact on prices. 









`





































































Check, if we can increase quality of model with adding variables.
```{r}
#lin_model2 <- lm(price ~ distance_to_jfk + neighbourhood_group + room_type + number_of_reviews, data = df_reduced2)
#summary(lin_model2)


#plot(df_reduced$distance_to_jfk, df_reduced$price, xlab = "Distance to #JFK (in meters)", ylab = "Price per night (in $)", main = "Regression #anaylsis (df_reduced)")
#abline(lin_model, col = "red")
```

Lets investigate if other focal points can express similar results.

```{r}

plot(df$distance_to_ewr, df$price)

```
For completeness: Do same with LGA Airport

```{r}

plot(df$distance_to_lga, df$price)

```

Not only airports can be focal points, sights might be also from interest. Therefore we look for the coordinates of statue of liberty, central park, empire state building.

```{r}
price_pct99 <- quantile(df$price, probs = 0.99)
df_reduced2 <- df %>% filter(price < price_pct99)

plot(df_reduced2$distance_to_sol, df_reduced2$price)
```
```{r}

lin_model3 <- lm(price ~ distance_to_sol, data = df_reduced2)
summary(lin_model3)


plot(df_reduced2$distance_to_sol, df_reduced2$price, xlab = "Distance to statue of liberty (in meters)", ylab = "Price per night (in $)", main = "Regression anaylsis (df_reduced2)")
abline(lin_model3, col = "red")

```

```{r}

price_pct99 <- quantile(df$price, probs = 0.99)
df_reduced2 <- df %>% filter(price < price_pct99)

plot(df_reduced2$distance_to_esb, df_reduced2$price)

```

```{r}
lin_model4 <- lm(price ~ distance_to_esb, data = df_reduced2)
summary(lin_model4)


plot(df_reduced2$distance_to_esb, df_reduced2$price, xlab = "Distance to empire state bulding (in kilometers)", ylab = "Price per night (in $)", main = "Regression anaylsis (df_reduced2)")
abline(lin_model3, col = "red")
```

```{r}
lin_model5 <- lm(price ~ distance_to_cp, data = df_reduced2)
summary(lin_model5)


plot(df_reduced2$distance_to_cp, df_reduced2$price, xlab = "Distance to central park (in kilometers)", ylab = "Price per night (in $)", main = "Regression anaylsis (df_reduced2)")
abline(lin_model5, col = "red")
```

```{r}
df_reduced2$sq_distance_to_esb <- df_reduced2$distance_to_esb^2

sq_model5 <- lm(price ~ distance_to_esb + sq_distance_to_esb, data = df_reduced2)
summary(sq_model5)
```
```{r}
values <- seq(0, 25, 0.1)

pred <- predict(sq_model5, list(distance_to_esb = values, sq_distance_to_esb = values^2))

plot(df_reduced2$distance_to_esb, df_reduced2$price, xlab = "Distance to esb (in kilometers)", ylab = "Price per night (in $)", main = "Regression anaylsis (df_reduced2)")
lines(values, pred, col = "blue")

```
```{r}
df_reduced2$sq_distance_to_esb <- df_reduced2$distance_to_esb^2
df_reduced2$poly_distance_to_esb <- df_reduced2$distance_to_esb^3

poly_model5 <- lm(price ~ distance_to_esb + sq_distance_to_esb + poly_distance_to_esb, data = df_reduced2)
summary(poly_model5)

values <- seq(0, 25, 0.1)

pred <- predict(poly_model5, list(distance_to_esb = values, sq_distance_to_esb = values^2, poly_distance_to_esb = values^3))

plot(df_reduced2$distance_to_esb, df_reduced2$price, xlab = "Distance to esb (in kilometers)", ylab = "Price per night (in $)", main = "Regression anaylsis (df_reduced2)")
lines(values, pred, col = "blue")

```

Now, use all calculated distances to sights to make a regression with on price.
```{r}
lin_model6 <- lm(price ~ distance_to_esb + distance_to_sol + distance_to_cp + neighbourhood_group, data = df_reduced2)
summary(lin_model6)


#plot(df_reduced2$distance_to_cp, df_reduced2$price, xlab = "Distance #to central park (in kilometers)", ylab = "Price per night (in $)", #main = "Regression anaylsis (df_reduced2)")
#abline(lin_model5, col = "green")
```
```{r}
bins <- c(0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 500)
labels <- c("0-5", "6-10", "11-15", "16-20", "21-25", "26-30", "31-35", "36-40", "41-45", "46-50", ">50")

df$distance_esb_bin <- cut(df$distance_to_esb, breaks = bins, labels = labels, include.lowest = TRUE, right = FALSE)

df_reduced2$distance_esb_bin <- cut(df_reduced2$distance_to_esb, breaks = bins, labels = labels, include.lowest = TRUE, right = FALSE)



table(df$distance_esb_bin)
table(df_reduced2$distance_esb_bin)

```
```{r}
df %>%
  group_by(distance_esb_bin) %>%
  summarise(mean = mean(price))
```
```{r}
ggplot(df_reduced2, aes(x=distance_esb_bin, y=price)) + 
  geom_boxplot()+
  stat_summary(fun.y=mean, geom="point", 
               shape=20, size=4, color="red", fill="red")
```



## Neighbourhood group distribution

```{r}

neighbourhood_group_counts <- df %>%
  count(neighbourhood_group)

population_df <- data.frame(
  neighbourhood_group = c("Manhattan", "Brooklyn", "Queens", "Staten Island", "Bronx"),
  population = c(1600000, 2500000, 2271000, 475000, 1427000)
)

area_df <- data.frame(
  neighbourhood_group = c("Manhattan", "Brooklyn", "Queens", "Staten Island", "Bronx"),
  area = c(59, 180, 280, 152, 110)
)

listing_count_pie_chart <- ggplot(neighbourhood_group_counts, aes(x = "", y = n, fill = neighbourhood_group)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y", start = 0) +
    ggtitle("Number of listings per neighbourhood group") +
    theme_void()

population_pie_chart <- ggplot(population_df, aes(x = "", y = population, fill = neighbourhood_group)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y", start = 0) +
    ggtitle("Population per neighbourhood groups") +
    theme_void()

area_pie_chart <- ggplot(area_df, aes(x = "", y = area, fill = neighbourhood_group)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y", start = 0) +
    ggtitle("Area per neighbourhood groups") +
    theme_void()

plots <- list(
  listing_count_pie_chart,
  population_pie_chart,
  area_pie_chart
)

grid.arrange(grobs = plots, padding = 2, ncol = 2)

```

```{r}

ggplot(df, aes(x = distance_from_center, y = price, color = neighbourhood_group)) +
  geom_point() +
  theme_minimal()

```



```{r}

ggplot(df, mapping = aes(y = log_price, x = neighbourhood_group)) +
  geom_boxplot()

```

```{r}

df %>%
  filter(log_price >= 0) %>% 
  ggplot(mapping = aes(x = log_price, y = neighbourhood_group)) +
  geom_density_ridges(alpha = 0.5)

```

## Most expensive neighbourhoods

```{r}

get_most_expensive_neighbourhoods_in_group <- function(group) {
  most_expensive_neighbourhoods <- df %>%
    filter(neighbourhood_group == group) %>%
    group_by(neighbourhood) %>%
    summarize(sum_price = sum(price)) %>%
    arrange(desc(sum_price))
  
  df %>%
    filter(neighbourhood_group == group) %>%
    group_by(neighbourhood, room_type) %>%
    summarise(sum_price = sum(price)) %>%
    arrange(match(neighbourhood, most_expensive_neighbourhoods$neighbourhood)) %>%
    mutate(neighbourhood = as.factor(neighbourhood)) %>%
    head(20) %>%
    ggplot(mapping = aes(x = factor(neighbourhood, level = most_expensive_neighbourhoods$neighbourhood), y = sum_price, fill = room_type)) +
    geom_col(stat = "identity") +
    labs(
      title = paste("Most expensive neighbourhoods in", group),
      x = "Neighbourhood",
      y = "Price in $"
    )
}

```

### Queens

```{r}

get_most_expensive_neighbourhoods_in_group("Queens")

```

### Brooklyn

```{r}

get_most_expensive_neighbourhoods_in_group("Brooklyn")

```

### Manhattan

```{r}

get_most_expensive_neighbourhoods_in_group("Manhattan")

```

### Staten Island

```{r}

get_most_expensive_neighbourhoods_in_group("Staten Island")

```

### Bronx

```{r}

get_most_expensive_neighbourhoods_in_group("Bronx")

```

### Queens

```{r}

get_most_expensive_neighbourhoods_in_group("Queens")

```

## Geographic Listing density

```{r}

icon_width <- 30
icon_height <- 30
icon_base_url <- "https://img.icons8.com/?size=2x&format=png&id="

statue_of_liberty_icon <- makeIcon(
  iconUrl = paste(icon_base_url, 4674),
  iconWidth = icon_width, iconHeight = icon_height
)

skyscraper_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "cGbCkzI99Cf8"),
  iconWidth = icon_width, iconHeight = icon_height
)

park_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "2410"),
  iconWidth = icon_width, iconHeight = icon_height
)

times_square_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "swhOdQ9tCaEq"),
  iconWidth = icon_width, iconHeight = icon_height
)

bridge_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "pJmt_hefPAkD"),
  iconWidth = icon_width, iconHeight = icon_height
)

museum_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "3496"),
  iconWidth = icon_width, iconHeight = icon_height
)

monument_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "4703"),
  iconWidth = icon_width, iconHeight = icon_height
)

college_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "11173"),
  iconWidth = icon_width, iconHeight = icon_height
)

stadium_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "JlLTMd4NfTIp"),
  iconWidth = icon_width, iconHeight = icon_height
)

airport_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "3683"),
  iconWidth = icon_width, iconHeight = icon_height
) 

ferry_icon <- makeIcon(
  iconUrl = paste(icon_base_url, "PLcwTvSptrJJ"),
  iconWidth = icon_width, iconHeight = icon_height
)

room_type_icons <- iconList(
  "Private room" = makeIcon(
    iconUrl = paste(icon_base_url, "BBsnsTkuoCkC"),
    iconWidth = icon_width, iconHeight = icon_height
  ),
  "Entire home/apt" = makeIcon(
    iconUrl = paste(icon_base_url, "Uc54oOGCsjOE"),
    iconWidth = icon_width, iconHeight = icon_height
  ),
  "Shared room" = makeIcon(
    iconUrl = paste(icon_base_url, "46791"),
    iconWidth = icon_width, iconHeight = icon_height
  )
)

```


```{r}

plot_map <- function (df, zoom, ratio, showMarkers) {
  center_lng <- (df %>% summarize(mean(longitude)))[1, 1]
  center_lat <- (df %>% summarize(mean(latitude)))[1, 1]
  
  map_max <- nrow(df) * ratio
  
  base_map <- df %>%
    leaflet() %>%
    addTiles() %>%
    addProviderTiles(providers$OpenStreetMap.DE) %>%
    setView(center_lng, center_lat, zoom) %>%
    addHeatmap(lng = ~longitude, lat = ~latitude, max = map_max, radius = 20, blur = 10)
  
  if (showMarkers)
    return(
      base_map %>%
        addMarkers(lat = 40.6897, lng = -74.0445, label = "Statue of Liberty", icon = statue_of_liberty_icon) %>%
        addMarkers(lat = 40.7484, lng = -73.9856, label = "Empire State Building", icon = skyscraper_icon) %>%
        addMarkers(lat = 40.7826, lng = -73.9655, label = "Central Park", icon = park_icon) %>%
        addMarkers(lat = 40.7579, lng = -73.9855, label = "Times Square", icon = times_square_icon) %>%
        addMarkers(lat = 40.7061, lng = -73.9967, label = "Brooklyn Bridge", icon = bridge_icon) %>%
        addMarkers(lat = 40.7188, lng = -73.9900, label = "Tenement Museum", icon = museum_icon) %>%
        addMarkers(lat = 40.7794, lng = -73.9632, label = "Metropolitan Museum of Art", icon = museum_icon) %>%
        addMarkers(lat = 40.7029, lng = -74.0153, label = "The Battery", icon = park_icon) %>%
        addMarkers(lat = 40.7074, lng = -73.9907, label = "Manhattan Bridge", icon = bridge_icon) %>%
        addMarkers(lat = 40.7136, lng = -73.9719, label = "Williamsburg Bridge", icon = bridge_icon) %>%
        addMarkers(lat = 40.7129, lng = -74.0132, label = "One World Observatory", icon = skyscraper_icon) %>%
        addMarkers(lat = 40.7129, lng = -74.0132, label = "Stonewall National Monument", icon = monument_icon) %>%
        addMarkers(lat = 40.7421, lng = -73.9879, label = "Madison Square Park", icon = park_icon) %>%
        addMarkers(lat = 40.7468, lng = -73.9582, label = "Gantry Plaza State Park", icon = park_icon) %>%
        addMarkers(lat = 40.8971, lng = -73.8862, label = "Van Cortlandt Park", icon = park_icon) %>%
        addMarkers(lat = 40.8655, lng = -73.8943, label = "Edgar Allan Poe Cottage", icon = monument_icon) %>%
        addMarkers(lat = 40.8729, lng = -73.8945, label = "Lehman College, CUNY", icon = college_icon) %>%
        addMarkers(lat = 40.8774, lng = -73.8794, label = "The Museum of Bronx History", icon = museum_icon) %>%
        addMarkers(lat = 40.8295, lng = -73.9262, label = "Yankee Stadium", icon = stadium_icon) %>%
        addMarkers(lat = 40.7563, lng = -73.9240, label = "Museum of the Moving Image", icon = museum_icon) %>%
        addMarkers(lat = 40.7767, lng = -73.8739, label = "LaGuardia Airport", icon = airport_icon) %>%
        addMarkers(lat = 40.7438, lng = -73.9351, label = "LaGuardia Community College", icon = college_icon) %>%
        addMarkers(lat = 40.6467, lng = -74.0765, label = "The Staten Island September 11th Memorial", icon = monument_icon) %>%
        addMarkers(lat = 40.6454, lng = -74.0822, label = "Curtis High School", icon = college_icon) %>%
        addMarkers(lat = 40.6436, lng = -74.0719, label = "Staten Island Ferry", icon = ferry_icon) %>%
        addMarkers(lat = 40.7022, lng = -73.9958, label = "Brooklyn Bridge Park", icon = park_icon) %>%
        addMarkers(lat = 40.6711, lng = -73.9637, label = "Brooklyn Museum", icon = museum_icon) %>%
        addMarkers(lat = 40.6913, lng = -73.9752, label = "Fort Greene Park", icon = park_icon)
    )
  
  base_map
}

```


```{r}

plot_map(df, zoom = 10, ratio = 0.05, showMarkers = F)

```

### Manhattan

```{r}

manhattan <- df %>%
  filter(neighbourhood_group == "Manhattan")

plot_map(manhattan, 11.5, ratio = 0.02, showMarkers = T)

```

### Bronx

```{r}

bronx <- df %>%
  filter(neighbourhood_group == "Bronx")

plot_map(bronx, 11.5, ratio = 0.01, showMarkers = T)

```

### Queens

```{r}

queens <- df %>%
  filter(neighbourhood_group == "Queens")

plot_map(queens, 12, ratio = 0.02, showMarkers = T)

```

```{r}

staten_island <- df %>%
  filter(neighbourhood_group == "Staten Island")

plot_map(staten_island, 12, ratio = 0.05, showMarkers = T)

```

### Brooklyn

```{r}

brooklyn <- df %>%
  filter(neighbourhood_group == "Brooklyn")

plot_map(brooklyn, 12, ratio = 0.02, showMarkers = T)

```

## Geographic distribution of room types

```{r}

plot_cluster_map <- function(df, zoom) {
  center_lng <- (df %>% summarize(mean(longitude)))[1, 1]
  center_lat <- (df %>% summarize(mean(latitude)))[1, 1]
    
  df %>%
    leaflet() %>%
    addTiles() %>%
    addProviderTiles(providers$OpenStreetMap.DE) %>%
    setView(center_lng, center_lat, zoom) %>%
    addMarkers(lng = ~longitude, lat = ~latitude, clusterOptions = markerClusterOptions(), label = ~name)
}

```

```{r}

plot_room_type_map <- function(df, zoom) {
  center_lng <- (df %>% summarize(mean(longitude)))[1, 1]
  center_lat <- (df %>% summarize(mean(latitude)))[1, 1]
    
  df %>%
    leaflet() %>%
    addTiles() %>%
    addProviderTiles(providers$OpenStreetMap.DE) %>%
    setView(center_lng, center_lat, zoom) %>%
    addMarkers(
      lng = ~longitude, 
      lat = ~latitude, 
      icon = ~room_type_icons[room_type], 
      label = ~name,
      popup = ~paste(sep = "<br/>",
        paste("<b>", name, "</b>"),
        paste("Price: ", price, "$"),
        paste("#Reviews: ", number_of_reviews),
        paste("Review age: ", last_review_age, "days"),
        paste("Availability: ", availability_365, "days")
      )
    )
}

```

```{r}

highest_review <- df %>%
  arrange(desc(number_of_reviews)) %>%
  head(100)
  
plot_room_type_map(
  highest_review, 
  11
)

```

```{r}

plot_room_type_map(df %>% filter(price_bin == "0-50") %>% arrange(desc(number_of_reviews)) %>% head(500), 11)

```


```{r}

plot_room_type_map(df %>% filter(price_bin == "1001+", number_of_reviews != 0) %>% arrange(last_review_age) %>% head(500), 11)

```


```{r}

plot_room_type_map(df %>% arrange(desc(number_of_reviews)) %>% head(10), 11)

```

```{r}

plot_room_type_map(df %>% arrange(availability_365) %>% head(200), 11)

```


### Private room

```{r}

private_room <- df %>%
  filter(room_type == "Private room")

plot_cluster_map(private_room, 10)

```

### Entire home

```{r}

entire_home <- df %>%
  filter(room_type == "Entire home/apt")

plot_cluster_map(entire_home, 10)

```

### Shared room

```{r}

shared_room <- df %>%
  filter(room_type == "Shared room")

plot_cluster_map(shared_room, 10)

```



## Most expensive listing position

```{r}

plot_marker_map <- function(df, zoom, color) {
  center_lng <- (most_expensive %>% summarize(mean(longitude)))[1, 1]
  center_lat <- (most_expensive %>% summarize(mean(latitude)))[1, 1]

  df %>%
    leaflet() %>%
    addTiles() %>%
    addProviderTiles(providers$OpenStreetMap.DE) %>%
    setView(center_lng, center_lat, zoom) %>%
    addCircleMarkers(lng = ~longitude, lat= ~latitude, label = ~name, color = color)
}

```

## Cheapest listings position

```{r}

most_expensive <- df %>%
  arrange(desc(price)) %>%
  head(10)

plot_marker_map(most_expensive, 11, "red")

```

```{r}

least_expensive <- df %>%
  arrange(price) %>%
  head(10)

plot_marker_map(least_expensive, 11, "blue")

```
